<div class="reservations-container">
  <h2 class="reservations-title">Mis Reservas</h2>
  <p class="reservations-subtitle">
    Aquí puedes ver todas tus reservas, tanto las próximas como las ya realizadas.
  </p>

  <!-- Estado de carga -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Cargando reservas...</span>
    </div>
  </div>

  <!-- Mensaje de error -->
  <div *ngIf="errorMessage && !loading" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    {{ errorMessage }}
  </div>

  <!-- Sin reservas -->
  <div *ngIf="reservations.length === 0 && !loading" class="no-reservations text-center py-5">
    <i class="bi bi-calendar-x display-1 text-muted mb-3"></i>
    <h4 class="text-muted">No tienes reservas aún</h4>
    <p class="text-secondary">Explora alojamientos y crea tu primera reserva</p>
    <button class="btn btn-primary mt-3" routerLink="/">
      <i class="bi bi-search me-2"></i>Buscar alojamientos
    </button>
  </div>

  <!-- Lista de reservas -->
  <div class="reservation-card" *ngFor="let r of reservations">

    <!-- Imagen del alojamiento -->
    <div class="reservation-image">
      <img
        [src]="r.imageUrl || '/assets/images/default-hotel.jpg'"
        alt="Imagen del alojamiento"
      />
    </div>

    <!-- Información principal -->
    <div class="reservation-info">
      <h3 class="accommodation-name">{{ r.accommodationName }}</h3>

      <p><strong>Entrada:</strong> {{ r.startDate | date: 'mediumDate' }}</p>
      <p><strong>Salida:</strong> {{ r.endDate | date: 'mediumDate' }}</p>

      <!-- Noches debajo de salida -->
      <p class="nights-text"><i class="bi bi-moon"></i> {{ r.nights }} noches</p>

      <div class="status-row">
        <span class="status" [ngClass]="r.status.toLowerCase()">
          <i class="bi" 
             [ngClass]="{
               'bi-clock-history': r.status === 'PENDING',
               'bi-check-circle-fill': r.status === 'CONFIRMED',
               'bi-x-circle-fill': r.status === 'CANCELLED',
               'bi-check2-all': r.status === 'COMPLETED'
             }"></i>
          {{ r.status }}
        </span>
      </div>

      <!-- ✅ ACCIONES ORIGINALES -->
      <div class="actions">
        <button 
          class="btn pay" 
          *ngIf="r.status === 'PENDING'" 
          (click)="payReservation(r.id)"
          title="Pagar con MercadoPago">
          <i class="bi bi-credit-card me-1"></i>
          Pagar ahora
        </button>
        <button 
          class="btn cancel" 
          *ngIf="r.status === 'PENDING' || r.status === 'CONFIRMED'" 
          (click)="cancelReservation(r.id)"
          title="Cancelar reserva">
          <i class="bi bi-x-lg me-1"></i>
          Cancelar
        </button>
        <button 
          class="btn btn-secondary" 
          *ngIf="r.status === 'CONFIRMED' || r.status === 'COMPLETED'" 
          routerLink="/accommodation/{{ r.accommodationId }}"
          title="Ver detalles">
          <i class="bi bi-eye me-1"></i>
          Ver detalles
        </button>
      </div>

      <!-- ✅ BOTÓN PARA DEJAR COMENTARIO -->
      <div class="actions" *ngIf="canLeaveComment(r)">
        <button class="btn comment-btn" (click)="openCommentDialog(r)">
          <i class="bi bi-chat-dots"></i> Dejar comentario
        </button>
      </div>

      <!-- ✅ YA COMENTADO -->
      <div class="comment-done" *ngIf="r.comment">
        <i class="bi bi-check-circle-fill text-success"></i>
        Ya dejaste un comentario
      </div>

    </div>

    <!-- Precio -->
    <div class="reservation-price">
      <span>{{ r.totalPrice | currency: 'COP':'symbol':'1.0-0' }}</span>
      <small class="text-muted d-block">Precio total</small>
    </div>
  </div>
</div>

<!-- ✅ MODAL DE COMENTARIO MEJORADO -->
<div class="modal-backdrop" *ngIf="selectedReservation">
  <div class="modal-box enhanced">
    <h3 class="modal-title">
      <i class="bi bi-chat-dots text-primary"></i>
      Dejar comentario
    </h3>

    <div class="modal-body">
      <p class="modal-subtitle">
        <strong>{{ selectedReservation.accommodationName }}</strong><br />
        Reserva #{{ selectedReservation.id }}
      </p>

      <!-- Calificación -->
      <label class="form-label">Calificación:</label>
      <div class="stars">
        <i
          *ngFor="let s of [1,2,3,4,5]"
          class="bi"
          [ngClass]="{
            'bi-star-fill text-warning': s <= rating,
            'bi-star text-secondary': s > rating
          }"
          (click)="rating = s"
        ></i>
      </div>

      <!-- Texto del comentario -->
      <label class="form-label mt-3">Tu experiencia</label>
      <textarea
        class="form-control comment-textarea"
        rows="4"
        [(ngModel)]="commentText"
        placeholder="Cuéntanos cómo fue tu estancia..."
      ></textarea>
    </div>

    <div class="modal-actions">
      <button class="btn btn-primary" (click)="submitComment()">
        <i class="bi bi-send"></i> Enviar
      </button>
      <button class="btn btn-outline-secondary" (click)="closeCommentDialog()">
        Cancelar
      </button>
    </div>
  </div>
</div>
